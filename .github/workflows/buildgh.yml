name: Build and Push Docker Image to Github Container Registry

on:
#   push:
#     tags:
#       - "*"
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    env:
      REPO_OWNER: ${{ github.repository_owner }}
      REPO_NAME: ${{ github.event.repository.name }}
      GITHUB_REF: ${{ github.ref }}
      GITHUB_EVENT_NAME: ${{ github.event_name }}

    steps:
    # Checkout the repository
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create .env file from secrets
      run: |
        echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env

    # Log in to GitHub Docker Registry
    - name: Log in to GitHub Container Registry
      run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin


    - name: Set image tag
      id: vars
      run: |
        if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
          echo "tag=${GITHUB_REF##refs/tags/}" >> $GITHUB_OUTPUT
        else
          echo "tag=dev" >> $GITHUB_OUTPUT
        fi

    - name: Build Docker image
      run: |
        REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
        REPO_NAME=$(basename "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
        IMAGE_TAG=${{ steps.vars.outputs.tag }}
        docker build --no-cache --tag ghcr.io/${REPO_OWNER}/${REPO_NAME}:${IMAGE_TAG} .
        docker tag ghcr.io/${REPO_OWNER}/${REPO_NAME}:${IMAGE_TAG} ghcr.io/${REPO_OWNER}/${REPO_NAME}:latest

    - name: Push Docker image
      run: |
        REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
        REPO_NAME=$(basename "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
        IMAGE_TAG=${{ steps.vars.outputs.tag }}
        docker push ghcr.io/${REPO_OWNER}/${REPO_NAME}:${IMAGE_TAG}
        docker push ghcr.io/${REPO_OWNER}/${REPO_NAME}:latest
